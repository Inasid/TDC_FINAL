<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trilingual Grid Poster</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@700&family=Noto+Nastaliq+Urdu:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .landing-banner {
            background: darkorchid;
            padding: 60px 40px;
            text-align: center;
            border-bottom: 1px solid #2a2a4a;
            max-height: 100vh;
        }

        .landing-banner h1 {
            font-size: 48px;
            color: #ffffff;
            margin-bottom: 16px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .landing-banner .subtitle {
            font-size: 18px;
            color: #b0b0b0;
            margin-bottom: 32px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        .landing-banner .links {
            display: flex;
            gap: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .landing-banner .links a {
            color: #4ecdc4;
            text-decoration: none;
            font-size: 16px;
            padding: 12px 24px;
            border: 1px solid #4ecdc4;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .landing-banner .links a:hover {
            background: #4ecdc4;
            color: #1a1a2e;
        }

        .generator-section {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }

        .container {
            display: flex;
            gap: 32px;
            max-width: 1600px;
            width: 100%;
        }

        .control-panel {
            width: 320px;
            background-color: #16213e;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #e0e0e0;
            font-size: 24px;
            margin-bottom: 24px;
            text-align: center;
        }

        h2 {
            color: #b0b0b0;
            font-size: 16px;
            margin: 20px 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 8px;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #4a4a6a;
            border-radius: 4px;
            font-size: 14px;
            background-color: #2a2a4a;
            color: white;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: Arial, sans-serif;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #5a67d8;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #3d3d5c;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .slider-value {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 4px;
        }

        .divider {
            border-top: 1px solid #4a4a6a;
            margin: 24px 0;
        }

        .color-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .preset-btn {
            width: 28px;
            height: 28px;
            border: 2px solid #5a67d8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            transform: scale(1.1);
            border-color: #7c8ff0;
        }

        .preset-btn.active {
            border: 3px solid white;
            box-shadow: 0 0 8px rgba(90, 103, 216, 0.6);
        }

        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .poster-container {
            background: white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            width: 500px;
            height: 700px;
            display: grid;
            grid-template-columns: repeat(70, 1fr);
            grid-template-rows: repeat(98, 1fr);
            gap: 0;
            max-width: 90vw;
            max-height: 90vh;
            aspect-ratio: 500 / 700;
        }

        .grid-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 0.25px solid #e0e0e0;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
            transition: background-image 0.15s ease-in-out;
        }

        .grid-cell.letter {
            border-color: #d0d0d0;
        }

        .body-copy-box {
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #d0d0d0;
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 9px;
            line-height: 1.5;
            color: #333;
            max-height: 100px;
            overflow: hidden;
            z-index: 10;
        }

        .download-btn {
            width: 100%;
            padding: 12px;
            background-color: #5a67d8;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 24px;
        }

        .download-btn:hover {
            background-color: #4c51bf;
        }

        .info-text {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 16px;
        }

        #tempCanvas {
            display: none;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                align-items: center;
            }

            .control-panel {
                width: 100%;
                max-width: 500px;
                max-height: none;
                order: 2;
            }

            .canvas-area {
                order: 1;
                width: 100%;
                display: flex;
                justify-content: center;
            }

            .poster-container {
                width: 90vw !important;
                height: calc(90vw * 1.4) !important;
                max-width: 500px;
                max-height: 700px;
            }
        }

        @media (max-width: 768px) {
            .landing-banner {
                padding: 40px 20px;
            }

            .landing-banner h1 {
                font-size: 32px;
                letter-spacing: 1px;
            }

            .landing-banner .subtitle {
                font-size: 15px;
                margin-bottom: 24px;
            }

            .landing-banner .links {
                flex-direction: column;
                gap: 12px;
            }

            .landing-banner .links a {
                width: 100%;
                max-width: 250px;
                text-align: center;
            }

            .generator-section {
                padding: 20px 12px;
            }

            .control-panel {
                padding: 16px;
            }

            .control-panel h1 {
                font-size: 20px;
            }

            .control-panel h2 {
                font-size: 14px;
            }

            .color-presets {
                justify-content: flex-start;
            }

            .preset-btn {
                width: 32px;
                height: 32px;
            }

            .poster-container {
                width: 95vw !important;
                height: calc(95vw * 1.4) !important;
            }

            .body-copy-box {
                font-size: 8px;
                padding: 8px;
                bottom: 8px;
                left: 8px;
                right: 8px;
            }
        }

        @media (max-width: 480px) {
            .landing-banner h1 {
                font-size: 26px;
            }

            .landing-banner .subtitle {
                font-size: 14px;
            }

            .control-panel h1 {
                font-size: 18px;
                margin-bottom: 16px;
            }

            label {
                font-size: 13px;
            }

            input[type="text"], textarea {
                font-size: 13px;
                padding: 8px;
            }

            .slider-value {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <canvas id="tempCanvas"></canvas>
    
    <!-- Landing Banner -->
    <div class="landing-banner">
        <h1>Lucknow Lattice</h1>
        <p class="subtitle">A generative typography project celebrating the architectural heritage of Lucknow through trilingual pixel art inspired by Mughal jali screens, chikankari motifs, and Indo-Islamic geometric patterns.</p>
        <div class="links">
            <a href="#generator">Try the Generator</a>
            <a href="https://github.com" target="_blank">View on GitHub</a>
            <a href="https://instagram.com" target="_blank">Follow on Instagram</a>
        </div>
    </div>

    <!-- Generator Section -->
    <div class="generator-section" id="generator">
    <div class="container">
        <div class="control-panel">
            <h1>Grid Letters Poster</h1>
            
            <div class="control-group">
                <label>English Headline</label>
                <textarea id="textEnglish" maxlength="50" style="min-height: 80px;">LUCKNOW</textarea>
                <small style="color: #9ca3af; margin-top: 4px; display: block;">Press Enter for line break</small>
            </div>

            <div class="control-group">
                <label>हिन्दी (Hindi)</label>
                <input type="text" id="textHindi" value="लखनऊ" maxlength="20">
            </div>

            <div class="control-group">
                <label>اردو (Urdu)</label>
                <input type="text" id="textUrdu" value="لکھنؤ" maxlength="20" dir="rtl">
            </div>

            <div class="control-group">
                <label>Body Copy</label>
                <textarea id="bodyCopy" maxlength="400" style="min-height: 100px;">Lucknow Lattice is a generative typography project celebrating the architectural heritage of Lucknow, India. The geometric patterns draw inspiration from the intricate jali screens, Mughal motifs, and Indo-Islamic designs found throughout the city's historic monuments.</textarea>
            </div>

            <div class="divider"></div>

            <h2>Grid Settings</h2>

            <div class="control-group">
                <label>Pixel Size</label>
                <input type="range" id="pixelSize" min="1" max="5" step="1" value="3">
                <div class="slider-value">Level <span id="pixelSizeValue">3</span></div>
            </div>

            <div class="divider"></div>

            <h2>Colors</h2>

            <div class="control-group">
                <label>Grid Background Color</label>
                <div class="color-presets" id="bgColorPresets"></div>
            </div>

            <div class="control-group">
                <label>Background Pattern Color</label>
                <div class="color-presets" id="bgPatternColorPresets"></div>
            </div>

            <div class="control-group">
                <label>Letter Grid Color</label>
                <div class="color-presets" id="letterColorPresets"></div>
            </div>

            <div class="divider"></div>

            <h2>Pattern Mix</h2>

            <div class="control-group">
                <label>Jali Diamond</label>
                <input type="range" id="pattern1" min="0" max="100" step="5" value="25">
                <div class="slider-value"><span id="pattern1Value">25</span>%</div>
            </div>

            <div class="control-group">
                <label>Chikan Buti</label>
                <input type="range" id="pattern2" min="0" max="100" step="5" value="25">
                <div class="slider-value"><span id="pattern2Value">25</span>%</div>
            </div>

            <div class="control-group">
                <label>Eight-pointed Star</label>
                <input type="range" id="pattern3" min="0" max="100" step="5" value="25">
                <div class="slider-value"><span id="pattern3Value">25</span>%</div>
            </div>

            <div class="control-group">
                <label>Floral Star</label>
                <input type="range" id="pattern4" min="0" max="100" step="5" value="25">
                <div class="slider-value"><span id="pattern4Value">25</span>%</div>
            </div>

            <button class="download-btn" id="downloadBtn">Download</button>

            <div class="info-text">
                ✓ Full Grid Layout | ✓ Letter Cells in Different Color | ✓ Animated Background
            </div>
        </div>

        <div class="canvas-area">
            <div class="poster-container" id="posterContainer"></div>
        </div>
    </div>
    </div>

    <script>
        const COLOR_PRESETS = {
            backgrounds: ['#ffffff', '#f0f0f0', '#e8e8e8', '#d0d0d0', '#fafafa'],
            bgPatterns: ['#e8e8e8', '#d0d0d0', '#c0c0c0', '#b0b0b0', '#a0a0a0'],
            letters: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b801', '#6c5ce7']
        };

        const PIXEL_SIZE_PRESETS = {
            1: { width: 100, height: 140 },
            2: { width: 85, height: 119 },
            3: { width: 70, height: 98 },
            4: { width: 60, height: 84 },
            5: { width: 50, height: 70 }
        };

        const SVG_PATTERNS = {
            // Frame_14 - Diamond cutout
            1: '<svg width="100%" height="100%" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg"><rect width="500" height="500" fill="white"/><path d="M500 500H0V0H500V500ZM20.2705 253.378L250 483.108L479.729 253.379L250 23.6484L20.2705 253.378Z" fill="{color}"/></svg>',
            // Frame_15 - Four petal flower
            2: '<svg width="100%" height="100%" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg"><rect width="500" height="500" fill="white"/><path d="M249.999 0C315.598 28.6621 358 74.1707 358 125.415C358 131.609 357.378 137.719 356.173 143.727C362.157 142.531 368.244 141.914 374.414 141.914C425.658 141.914 471.166 184.315 499.828 249.913C471.166 315.512 425.657 357.914 374.413 357.914C368.243 357.914 362.157 357.297 356.173 356.102C357.378 362.109 358 368.22 358 374.415C358 425.659 315.6 471.167 250.002 499.829C184.402 471.167 142 425.659 142 374.414C142 368.207 142.623 362.084 143.833 356.065C137.791 357.285 131.645 357.914 125.414 357.914C74.1705 357.914 28.6621 315.514 0 249.916C28.662 184.316 74.1705 141.914 125.415 141.914C131.646 141.914 137.792 142.542 143.833 143.762C142.623 137.743 142 131.621 142 125.414C142 74.1702 184.401 28.6621 249.999 0Z" fill="{color}"/></svg>',
            // Frame_16 - Eight-pointed star (overlapping squares)
            3: '<svg width="100%" height="100%" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg"><rect width="500" height="500" fill="white"/><rect x="73.2236" y="73.2126" width="353.555" height="353.584" fill="{color}"/><rect width="353.568" height="353.568" transform="matrix(0.707077 0.707136 -0.707077 0.707136 250.001 -0.0174561)" fill="{color}"/></svg>',
            // Frame_24 - Floral star with inner petals
            4: '<svg width="100%" height="100%" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg"><rect width="500" height="500" fill="white"/><path d="M500 249.966C499.19 253.106 496.661 253.714 494.064 254.018C484.183 255.098 474.639 257.461 465.634 261.749C425.367 280.959 396.735 310.837 382.132 353.477C380.547 358.069 379.805 362.897 379.333 367.758C378.76 373.869 374.713 378.46 368.71 379.068C348.239 381.229 330.804 390.479 314.38 402.026C289.086 419.818 270.943 443.315 259.375 471.978C257.014 477.853 255.564 483.997 254.755 490.277C254.485 492.505 254.013 494.733 253.406 496.894C252.967 498.447 252.057 500 250.101 499.966C248.178 499.966 247.369 498.447 246.796 496.86C246.56 496.252 246.222 495.679 246.189 495.071C244.368 473.835 234.79 455.841 222.784 438.825C205.011 413.707 181.674 395.679 153.21 384.2C147.342 381.837 141.272 380.182 134.965 379.473C124.78 378.325 121.914 375.354 120.531 365.024C118.305 348.447 111.021 333.896 102.016 320.088C83.2317 291.222 57.9046 270.459 25.6302 258.305C19.3912 255.942 12.8486 254.794 6.2386 254.018C4.75472 253.849 3.33829 253.646 2.09048 252.802C-0.607485 250.945 -0.742383 248.953 2.05675 247.13C2.96732 246.523 4.11395 246.117 5.19314 245.982C28.2944 243.788 47.6186 232.917 65.5938 219.21C89.4708 200.979 106.637 177.718 117.024 149.494C118.811 144.632 119.991 139.568 120.565 134.402C121.61 124.814 124.949 121.573 134.527 120.493C150.984 118.602 165.351 111.344 179.111 102.6C206.293 85.3477 226.021 61.715 239.241 32.4781C242.917 24.3079 245.042 15.6313 246.088 6.71843C246.189 5.90817 246.088 5.06415 246.357 4.3214C246.964 2.32951 247.605 0 250.202 0C252.529 0 253.203 2.1607 253.912 3.98379C254.08 4.42269 254.148 4.9291 254.181 5.40176C256.137 26.2323 265.445 44.0243 277.249 60.7022C295.797 86.9345 320.113 105.773 350.263 116.88C355.557 118.839 361.088 120.358 366.821 120.527C373.735 120.695 379.063 126.907 379.67 133.592C381.222 150.608 388.877 165.429 398.017 179.541C416.767 208.406 441.993 229.237 474.2 241.492C480.608 243.923 487.285 245.003 494.064 245.881C496.661 246.219 499.224 246.759 500 249.932V249.966Z" fill="{color}"/></svg>'
        };

        const state = {
            textEnglish: 'LUCKNOW',
            textHindi: 'लखनऊ',
            textUrdu: 'لکھنؤ',
            bodyCopy: 'Lucknow Lattice is a generative typography project celebrating the architectural heritage of Lucknow, India. The geometric patterns draw inspiration from the intricate jali screens, Mughal motifs, and Indo-Islamic designs found throughout the city\'s historic monuments.',
            bgColor: '#ffffff',
            bgPatternColor: '#e8e8e8',
            letterColor: '#ff6b6b',
            patterns: { pattern1: 25, pattern2: 25, pattern3: 25, pattern4: 25 },
            pixelSize: 3,
            letterPositions: new Set(),
            bgGridAnimationInterval: null
        };

        function generatePattern(patternNum, color) {
            const svg = SVG_PATTERNS[patternNum];
            return svg.replace(/{color}/g, color);
        }

        function getRandomPattern() {
            const total = state.patterns.pattern1 + state.patterns.pattern2 + state.patterns.pattern3 + state.patterns.pattern4;
            if (total === 0) return 1;
            const rand = Math.random() * total;
            let sum = 0;
            if (rand < (sum += state.patterns.pattern1)) return 1;
            if (rand < (sum += state.patterns.pattern2)) return 2;
            if (rand < (sum += state.patterns.pattern3)) return 3;
            return 4;
        }

        function renderTextToGrid(text, fontFamily, fontSize) {
            if (!text) return null;
            const canvas = document.getElementById('tempCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 2000;
            canvas.height = 500;
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#000000';
            ctx.font = `bold ${fontSize}px ${fontFamily}, sans-serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            
            ctx.fillText(text, 50, 250);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let minX = canvas.width, maxX = 0, minY = canvas.height, maxY = 0;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const isBlack = (r + g + b) / 3 < 128;
                
                if (isBlack) {
                    const pixelIndex = i / 4;
                    const x = pixelIndex % canvas.width;
                    const y = Math.floor(pixelIndex / canvas.width);
                    
                    minX = Math.min(minX, x);
                    maxX = Math.max(maxX, x);
                    minY = Math.min(minY, y);
                    maxY = Math.max(maxY, y);
                }
            }
            
            const charWidth = maxX - minX + 1;
            const charHeight = maxY - minY + 1;
            
            if (charWidth <= 0 || charHeight <= 0) {
                return null;
            }
            
            const gridWidth = Math.ceil(charWidth / 1.5);
            const gridHeight = Math.ceil(charHeight / 1.5);
            
            const grid = [];
            for (let y = 0; y < gridHeight; y++) {
                const row = [];
                for (let x = 0; x < gridWidth; x++) {
                    const srcX = Math.floor(minX + (x * charWidth) / gridWidth);
                    const srcY = Math.floor(minY + (y * charHeight) / gridHeight);
                    const pixelIndex = (srcY * canvas.width + srcX) * 4;
                    
                    const r = data[pixelIndex];
                    const g = data[pixelIndex + 1];
                    const b = data[pixelIndex + 2];
                    const isBlack = (r + g + b) / 3 < 128;
                    
                    row.push(isBlack ? 1 : 0);
                }
                grid.push(row);
            }
            
            return { grid };
        }

        function render() {
            const container = document.getElementById('posterContainer');
            container.innerHTML = '';
            state.letterPositions.clear();
            
            // Get current grid dimensions based on pixel size
            const gridDims = PIXEL_SIZE_PRESETS[state.pixelSize];
            const GRID_WIDTH = gridDims.width;
            const GRID_HEIGHT = gridDims.height;
            
            // Update CSS grid
            container.style.gridTemplateColumns = `repeat(${GRID_WIDTH}, 1fr)`;
            container.style.gridTemplateRows = `repeat(${GRID_HEIGHT}, 1fr)`;
            
            let currentRow = Math.floor(GRID_HEIGHT * 0.1);
            
            // English
            if (state.textEnglish.trim()) {
                const englishLines = state.textEnglish.split('\n');
                for (const line of englishLines) {
                    if (!line.trim()) continue;
                    const gridData = renderTextToGrid(line.toUpperCase(), 'Pixelify Sans', 18);
                    if (gridData) {
                        const { grid } = gridData;
                        let currentCol = Math.max(0, Math.floor((GRID_WIDTH - grid[0].length) / 2));
                        grid.forEach((row, r) => {
                            row.forEach((cell, c) => {
                                if (cell === 1 && (currentRow + r) < GRID_HEIGHT && (currentCol + c) < GRID_WIDTH) {
                                    const cellIdx = Math.floor((currentRow + r) * GRID_WIDTH + (currentCol + c));
                                    state.letterPositions.add(cellIdx);
                                }
                            });
                        });
                        currentRow += grid.length + 5;
                    }
                }
            }
            
            // Hindi
            if (state.textHindi.trim()) {
                const gridData = renderTextToGrid(state.textHindi, 'Noto Sans Devanagari', 18);
                if (gridData) {
                    const { grid } = gridData;
                    let currentCol = Math.max(0, Math.floor((GRID_WIDTH - grid[0].length) / 2));
                    grid.forEach((row, r) => {
                        row.forEach((cell, c) => {
                            if (cell === 1 && (currentRow + r) < GRID_HEIGHT && (currentCol + c) < GRID_WIDTH) {
                                const cellIdx = Math.floor((currentRow + r) * GRID_WIDTH + (currentCol + c));
                                state.letterPositions.add(cellIdx);
                            }
                        });
                    });
                    currentRow += grid.length + 5;
                }
            }
            
            // Urdu
            if (state.textUrdu.trim()) {
                const gridData = renderTextToGrid(state.textUrdu, 'Noto Nastaliq Urdu', 18);
                if (gridData) {
                    const { grid } = gridData;
                    let currentCol = Math.max(0, Math.floor((GRID_WIDTH - grid[0].length) / 2));
                    grid.forEach((row, r) => {
                        row.forEach((cell, c) => {
                            if (cell === 1 && (currentRow + r) < GRID_HEIGHT && (currentCol + c) < GRID_WIDTH) {
                                const cellIdx = Math.floor((currentRow + r) * GRID_WIDTH + (currentCol + c));
                                state.letterPositions.add(cellIdx);
                            }
                        });
                    });
                }
            }
            
            // Create grid cells
            for (let i = 0; i < GRID_WIDTH * GRID_HEIGHT; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                
                const pattern = getRandomPattern();
                
                if (state.letterPositions.has(i)) {
                    cell.classList.add('letter');
                    const svg = generatePattern(pattern, state.letterColor);
                    const dataUrl = `url('data:image/svg+xml;utf8,${encodeURIComponent(svg)}')`;
                    cell.style.backgroundImage = dataUrl;
                } else {
                    // For background, use the selected background pattern color
                    const svg = generatePattern(pattern, state.bgPatternColor);
                    const dataUrl = `url('data:image/svg+xml;utf8,${encodeURIComponent(svg)}')`;
                    cell.style.backgroundImage = dataUrl;
                }
                
                container.appendChild(cell);
            }
            
            // Add body copy box
            if (state.bodyCopy.trim()) {
                const bodyBox = document.createElement('div');
                bodyBox.className = 'body-copy-box';
                bodyBox.textContent = state.bodyCopy;
                container.appendChild(bodyBox);
            }
            
            startAnimation();
        }

        function animateBackgroundGrid() {
            const allCells = Array.from(document.querySelectorAll('.grid-cell'));
            const bgCells = allCells.filter((cell, idx) => !state.letterPositions.has(idx));
            
            if (bgCells.length < 2) return;
            
            // Swap patterns between cells
            const numSwaps = Math.floor(bgCells.length * 0.1);
            for (let i = 0; i < numSwaps; i++) {
                const idx1 = Math.floor(Math.random() * bgCells.length);
                const idx2 = Math.floor(Math.random() * bgCells.length);
                
                if (idx1 !== idx2) {
                    const temp = bgCells[idx1].style.backgroundImage;
                    bgCells[idx1].style.backgroundImage = bgCells[idx2].style.backgroundImage;
                    bgCells[idx2].style.backgroundImage = temp;
                }
            }
            
            // Randomly change some cells to new patterns
            const numChanges = Math.floor(bgCells.length * 0.08);
            for (let i = 0; i < numChanges; i++) {
                const idx = Math.floor(Math.random() * bgCells.length);
                const pattern = getRandomPattern();
                const svg = generatePattern(pattern, state.bgPatternColor);
                const dataUrl = `url('data:image/svg+xml;utf8,${encodeURIComponent(svg)}')`;
                bgCells[idx].style.backgroundImage = dataUrl;
            }
        }

        function startAnimation() {
            if (state.bgGridAnimationInterval) clearInterval(state.bgGridAnimationInterval);
            state.bgGridAnimationInterval = setInterval(() => {
                animateBackgroundGrid();
            }, 200);
        }

        function createColorPresets() {
            const bgContainer = document.getElementById('bgColorPresets');
            COLOR_PRESETS.backgrounds.forEach((color, idx) => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn' + (idx === 0 ? ' active' : '');
                btn.style.backgroundColor = color;
                btn.onclick = () => {
                    state.bgColor = color;
                    bgContainer.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    render();
                };
                bgContainer.appendChild(btn);
            });

            const bgPatternContainer = document.getElementById('bgPatternColorPresets');
            COLOR_PRESETS.bgPatterns.forEach((color, idx) => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn' + (idx === 0 ? ' active' : '');
                btn.style.backgroundColor = color;
                btn.onclick = () => {
                    state.bgPatternColor = color;
                    bgPatternContainer.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    render();
                };
                bgPatternContainer.appendChild(btn);
            });
            
            const letterContainer = document.getElementById('letterColorPresets');
            COLOR_PRESETS.letters.forEach((color, idx) => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn' + (idx === 0 ? ' active' : '');
                btn.style.backgroundColor = color;
                btn.onclick = () => {
                    state.letterColor = color;
                    letterContainer.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    render();
                };
                letterContainer.appendChild(btn);
            });
        }

        document.getElementById('textEnglish').addEventListener('input', (e) => {
            state.textEnglish = e.target.value;
            render();
        });

        document.getElementById('textHindi').addEventListener('input', (e) => {
            state.textHindi = e.target.value;
            render();
        });

        document.getElementById('textUrdu').addEventListener('input', (e) => {
            state.textUrdu = e.target.value;
            render();
        });

        document.getElementById('bodyCopy').addEventListener('input', (e) => {
            state.bodyCopy = e.target.value;
            render();
        });

        ['pattern1', 'pattern2', 'pattern3', 'pattern4'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                state.patterns[id] = parseInt(e.target.value);
                document.getElementById(id + 'Value').textContent = state.patterns[id];
                render();
            });
        });

        document.getElementById('pixelSize').addEventListener('input', (e) => {
            state.pixelSize = parseInt(e.target.value);
            document.getElementById('pixelSizeValue').textContent = state.pixelSize;
            render();
        });

        document.getElementById('downloadBtn').addEventListener('click', async () => {
            const poster = document.getElementById('posterContainer');
            const downloadBtn = document.getElementById('downloadBtn');
            
            // Stop animation temporarily
            if (state.bgGridAnimationInterval) {
                clearInterval(state.bgGridAnimationInterval);
            }
            
            downloadBtn.textContent = 'Generating...';
            downloadBtn.disabled = true;
            
            try {
                // Get current grid dimensions
                const gridDims = PIXEL_SIZE_PRESETS[state.pixelSize];
                const GRID_WIDTH = gridDims.width;
                const GRID_HEIGHT = gridDims.height;
                
                // Create a high-res canvas
                const scale = 2;
                const canvasWidth = 500 * scale;
                const canvasHeight = 700 * scale;
                const cellWidth = canvasWidth / GRID_WIDTH;
                const cellHeight = canvasHeight / GRID_HEIGHT;
                
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = canvasWidth;
                exportCanvas.height = canvasHeight;
                const ctx = exportCanvas.getContext('2d');
                
                // Fill white background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                
                // Get all cells and render them
                const cells = poster.querySelectorAll('.grid-cell');
                
                // Create a function to load and draw SVG
                const drawCell = (cellIndex) => {
                    return new Promise((resolve) => {
                        const cell = cells[cellIndex];
                        const bgImage = cell.style.backgroundImage;
                        
                        if (bgImage && bgImage.startsWith("url(")) {
                            // Extract SVG data
                            let svgData = bgImage.slice(5, -2); // Remove url(' and ')
                            svgData = decodeURIComponent(svgData.replace('data:image/svg+xml;utf8,', ''));
                            
                            // Create image from SVG
                            const img = new Image();
                            const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
                            const url = URL.createObjectURL(svgBlob);
                            
                            img.onload = () => {
                                const row = Math.floor(cellIndex / GRID_WIDTH);
                                const col = cellIndex % GRID_WIDTH;
                                const x = col * cellWidth;
                                const y = row * cellHeight;
                                
                                ctx.drawImage(img, x, y, cellWidth, cellHeight);
                                URL.revokeObjectURL(url);
                                resolve();
                            };
                            
                            img.onerror = () => {
                                URL.revokeObjectURL(url);
                                resolve();
                            };
                            
                            img.src = url;
                        } else {
                            resolve();
                        }
                    });
                };
                
                // Draw all cells
                for (let i = 0; i < cells.length; i++) {
                    await drawCell(i);
                }
                
                // Draw body copy box
                if (state.bodyCopy.trim()) {
                    const padding = 24 * scale;
                    const boxPadding = 20 * scale;
                    const boxHeight = 100 * scale;
                    const boxY = canvasHeight - padding - boxHeight;
                    
                    // Draw box background
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.strokeStyle = '#d0d0d0';
                    ctx.lineWidth = 2 * scale;
                    
                    const boxX = padding;
                    const boxWidth = canvasWidth - (padding * 2);
                    
                    // Rounded rectangle
                    const radius = 8 * scale;
                    ctx.beginPath();
                    ctx.moveTo(boxX + radius, boxY);
                    ctx.lineTo(boxX + boxWidth - radius, boxY);
                    ctx.quadraticCurveTo(boxX + boxWidth, boxY, boxX + boxWidth, boxY + radius);
                    ctx.lineTo(boxX + boxWidth, boxY + boxHeight - radius);
                    ctx.quadraticCurveTo(boxX + boxWidth, boxY + boxHeight, boxX + boxWidth - radius, boxY + boxHeight);
                    ctx.lineTo(boxX + radius, boxY + boxHeight);
                    ctx.quadraticCurveTo(boxX, boxY + boxHeight, boxX, boxY + boxHeight - radius);
                    ctx.lineTo(boxX, boxY + radius);
                    ctx.quadraticCurveTo(boxX, boxY, boxX + radius, boxY);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // Draw text
                    ctx.fillStyle = '#333333';
                    ctx.font = `${11 * scale}px Arial, sans-serif`;
                    
                    // Word wrap
                    const words = state.bodyCopy.split(' ');
                    let line = '';
                    let y = boxY + boxPadding + (12 * scale);
                    const maxWidth = boxWidth - (boxPadding * 2);
                    const lineHeight = 14 * scale;
                    
                    for (let word of words) {
                        const testLine = line + word + ' ';
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && line !== '') {
                            ctx.fillText(line.trim(), boxX + boxPadding, y);
                            line = word + ' ';
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    ctx.fillText(line.trim(), boxX + boxPadding, y);
                }
                
                // Download
                const link = document.createElement('a');
                link.download = 'lucknow-lattice-poster.png';
                link.href = exportCanvas.toDataURL('image/png', 1.0);
                link.click();
                
            } catch (error) {
                console.error('Download failed:', error);
                alert('Download failed. Please try again.');
            }
            
            downloadBtn.textContent = 'Download';
            downloadBtn.disabled = false;
            
            // Restart animation
            startAnimation();
        });

        setTimeout(() => {
            createColorPresets();
            render();
        }, 500);
    </script>
</body>
</html>